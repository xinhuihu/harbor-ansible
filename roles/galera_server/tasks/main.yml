---
# Copyright 2014, Rackspace US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Fail when the host is not in galera_cluster_members
  fail:
    msg: "The host {{ inventory_hostname }} must be in galera_cluster_members."
  when: inventory_hostname not in galera_cluster_members
  tags:
    - always

- name: Fail if the galera root password is not provided
  fail:
    msg: |
      Please set the galera_root_password variable prior to applying the
      galera role.
  when: (galera_root_password is undefined) or (galera_root_password is none)
  tags:
    - always

- name: Fail if compression is enabled on unsupported architecture/distro
  fail:
    msg: |
      qpress compression is only supported for x86_64 and for Ubuntu/ppc64le
  when:
    - galera_xtrabackup_compression | bool
    - (ansible_architecture != 'x86_64') and
      not (ansible_architecture == 'ppc64le' and ansible_distribution == 'Ubuntu')

- name: Gather variables for each operating system
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_version | lower }}.yml"
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
    - "{{ ansible_os_family | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
  tags:
    - always

- name: initialize local facts
  ini_file:
    dest: "/etc/ansible/facts.d/openstack_ansible.fact"
    section: "galera"
    option: initialized
    value: true

- name: Refresh local facts
  setup:
    filter: ansible_local
    gather_subset: "!all"
  tags:
    - always

- name: Set the galera existing cluster fact
  set_fact:
    galera_deployed: "{{ ansible_local['openstack_ansible']['galera']['deployed'] | default(false) | bool }}"
  tags:
    - always

- name: Cluster state notice
  debug:
    msg: >
      The cluster state will be ignored. While the state checks are skipped,
      the galera restart handlers will be triggered to ensure everything is
      functional at the end of the playbook execution.
  changed_when: true
  when:
    - (galera_ignore_cluster_state | bool) or (galera_force_bootstrap | bool)
  notify:
    - Manage LB
    - Restart all mysql
  tags:
    - always

- include_tasks: galera_cluster_state.yml
  when:
    - galera_deployed | bool
    - not galera_ignore_cluster_state | bool
  tags:
    - always

- include_tasks: galera_upgrade.yml
  tags:
    - galera_server-upgrade

- include_tasks: galera_install.yml
  tags:
    - galera_server-install

- include_tasks: galera_post_install.yml
  tags:
    - galera_server-config

- name: Flush handlers
  meta: flush_handlers

- include_tasks: galera_setup.yml
  tags:
    - galera_server-config
