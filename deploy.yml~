---
- name:  Install requirements  befor deploy the harbor instances
  hosts: harbor-cluster
  roles:
    - name: Run the commone role
      role: common

    - name: Config target hosts for no ssh password 
      role: pre-harbor

    - name: Setup docker engine on nodes
      role: docker
      when:
        - deployment_platform == "docker" and docker_required == true

- name:  Install db cluster
  hosts: harbor-cluster:db-cluster
  roles: 
    - name: Install MariaDB cluster
      role: MariaDB

    - name: Install PostgresSQL cluster
      role: PostgresSQL
      when:
        - clair == true 

- name:  Install redis cluster
  hosts: harbor-cluster:redis-cluster
  role:  redis

- name: install harbor instance on the target nodes
  hosts: harbor-cluster:harbor-instances
  roles:
    - name: install docker-compose on the harbor instances node
      role: docker-compose
    
    - name: Config the harbor instances to ues the share storage
      role: storage
      when:
        - share_storage == true

    - name: install harbor instances
      role: harbor

- name:  Install and loadbalance for Harbor cluster
  hosts: harbor-cluster:loadbalance
  role: loadbalance
  when:
    - ha == true
